stages:
    - build
    - build-image
    - deploy

workflow:
    rules:
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "stable"

variables:
    GIT_DEPTH: '16'
    GIT_STRATEGY: clone
    GIT_SUBMODULE_STRATEGY: recursive
    CONTAINER_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}/postguard-website:${CI_COMMIT_REF_NAME}

build-root-main:
    stage: build
    tags: [docker]
    only: 
        - main
    image: node:18-alpine3.15
    script:
        - git checkout env_vars
        - yarn
        - yarn build-main
    artifacts:
        paths:
            - build
        expire_in: 1 day

build-root-stable:
    stage: build
    tags: [docker]
    only:
        - stable
    image: node:18-alpine3.15
    script:
        - yarn
        - yarn build-stable
    artifacts:
        paths:
            - build
        expire_in: 1 day

build-cryptify:
    stage: build
    tags: [docker]
    image: node:18-alpine3.15
    script:
        - cd cryptify/cryptify-front-end
        - npm install --legacy-peer-deps
        - CI=false npm run build
    artifacts:
        paths:
            - cryptify/cryptify-front-end/build
        expire_in: 1 day

build-downloads:
    stage: build
    tags: [docker]
    image: node:18-alpine3.15
    script:
        - cd postguard-tb-addon
        - yarn
        - NODE_ENV=production yarn build
        - cd dist
        - ln -s postguard-tb-addon-*.xpi postguard-tb-addon.xpi
    artifacts:
        paths:
            - postguard-tb-addon/dist
        expire_in: 1 day

build-image-stable:
    stage: build-image
    tags: [docker]
    only:
        - stable
    dependencies:
        - build-root-stable
        - build-cryptify
        - build-downloads
    image: docker:stable
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - docker build -f docker/nginx.Dockerfile -t ${CONTAINER_IMAGE} .
        - docker push ${CONTAINER_IMAGE}

build-image-main:
    stage: build-image
    tags: [docker]
    only:
        - main
    dependencies:
        - build-root-main
        - build-cryptify
        - build-downloads
    image: docker:stable
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - docker build -f docker/nginx.Dockerfile -t ${CONTAINER_IMAGE} .
        - docker push ${CONTAINER_IMAGE}

deploy-main:
    stage: deploy
    only:
        - main
    dependencies:
        - build-image-main
    environment: $CI_COMMIT_REF_NAME
    tags: [docker]
    image: ubuntu:rolling
    script:
        - apt update
        - apt install -y openssh-client
        - chmod 600 $ILAB_VM_TRIGGER_UPDATE_KEY
        - ssh -o UserKnownHostsFile=$ILAB_VM_TRIGGER_UPDATE_KNOWN_HOSTS $ILAB_VM_TRIGGER_UPDATE_USER@$PG_VM_TRIGGER_UPDATE_HOST_MAIN -i $ILAB_VM_TRIGGER_UPDATE_KEY docker-postguard-website-main

deploy-stable:
    stage: deploy
    only:
        - stable
    dependencies:
        - build-image-stable
    environment: $CI_COMMIT_REF_NAME
    tags: [docker]
    image: ubuntu:rolling
    script:
        - apt update
        - apt install -y openssh-client
        - chmod 600 $ILAB_VM_TRIGGER_UPDATE_KEY
        - ssh -o UserKnownHostsFile=$ILAB_VM_TRIGGER_UPDATE_KNOWN_HOSTS $ILAB_VM_TRIGGER_UPDATE_USER@$PG_VM_TRIGGER_UPDATE_HOST_STABLE -i $ILAB_VM_TRIGGER_UPDATE_KEY docker-postguard-website-stable
